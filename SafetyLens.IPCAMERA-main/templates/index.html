{% extends "base.html" %}

{% block title %}Dashboard - SafetyLens{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- Cards de Estatísticas -->
    <div class="row g-4">
        <div class="col-12 col-md-4">
            <div class="stats-card card h-100">
                <div class="icon" style="color: #ffc107;">
                    <i class="fas fa-chart-bar" style="color: #ffc107 !important;"></i>
                </div>
                <div class="number" style="color:rgb(224, 169, 3);">{{ total_detections }}</div>
                <div class="label">Total de Detecções <p> (Últimos 30 dias)</div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="stats-card card h-100">
                <div class="icon" style="color: #fd7e14;">
                    <i class="fas fa-clock" style="color: #fd7e14 !important;"></i>
                </div>
                <div class="number" style="color: #8a4b00;">
                    {% if last_detection %}
                        {{ last_detection[1].split(' ')[1] }}
                    {% else %}
                        -
                    {% endif %}
                </div>
                <div class="label">Última Detecção</div>
                {% if last_detection %}
                    <small class="text-muted">
                        {% set date_parts = last_detection[1].split(' ')[0].split('-') %}
                        {{ date_parts[2] }}-{{ date_parts[1] }}-{{ date_parts[0] }}
                    </small>
                {% endif %}
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="stats-card card h-100">
                <div class="icon" style="color: #dc3545;">
                    <i class="fas fa-exclamation-triangle" style="color: #dc3545 !important;"></i>
                </div>
                <div class="number" style="color: #dc3545;">
                    {% if last_detection %}
                        {{ last_detection[3] }}
                    {% else %}
                        -
                    {% endif %}
                </div>
                <div class="label">Último EPI Ausente</div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row g-4 mt-4">
        <div class="col-12 col-lg-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-chart-pie me-2"></i>Frequência de EPIs Ausentes (Últimos 30 dias)
                    </h5>
                    <div class="chart-container">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-chart-line me-2"></i>Evolução Temporal (Últimos 30 dias)
                    </h5>
                    <div class="chart-container">
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Últimas Detecções -->
    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">
                <i class="fas fa-history me-2"></i>Últimas Detecções
            </h5>
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Data/Hora</th>
                            <th>EPIs Ausentes</th>
                            <th class="text-center">Imagem</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in detections[:5] %}
                        <tr>
                            <td>{{ row[0] }}</td>
                            <td>
                                {% set date_parts = row[1].split(' ')[0].split('-') %}
                                {{ date_parts[2] }}-{{ date_parts[1] }}-{{ date_parts[0] }}
                                {{ row[1].split(' ')[1] }}
                            </td>
                            <td>{{ row[3] }}</td>
                            <td class="text-center">
                                {% if row[2] %}
                                <a href="/image/{{row[0]}}" class="btn btn-sm btn-primary" target="_blank">
                                    <i class="fas fa-image me-1"></i>Visualizar
                                </a>
                                {% else %}
                                <span class="text-muted">
                                    <i class="fas fa-ban"></i>
                                </span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="text-end mt-3">
                <a href="{{ url_for('detections') }}" class="btn btn-primary">
                    <i class="fas fa-list me-1"></i>Ver Todas
                </a>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Configuração dos gráficos com tema consistente
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        }
    };

    // Gráfico de barras
    const chartData = { chart_data,safe };
    new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
            labels: chartData.labels,
            datasets: [{
                data: chartData.counts,
                backgroundColor: '#3b82f6',
                borderColor: '#2563eb',
                borderWidth: 1,
                borderRadius: 4
            }]
        },
        options: chartOptions
    });

    // Gráfico de linha
    const evolutionChartData = { evolution_chart_data,safe };
    new Chart(document.getElementById('lineChart'), {
        type: 'line',
        data: {
            labels: evolutionChartData.labels,
            datasets: [{
                data: evolutionChartData.counts,
                fill: true,
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderColor: '#3b82f6',
                tension: 0.4,
                pointRadius: 4,
                pointBackgroundColor: '#ffffff',
                pointBorderColor: '#3b82f6',
                pointBorderWidth: 2
            }]
        },
        options: {
            ...chartOptions,
            scales: {
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        autoSkip: true,
                        maxTicksLimit: 10
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });
</script>
{% endblock %}